# ТЗ: генератор документов (FreshDoc-like) + AI агент по сущностям

Цель: сделать генератор похожим на FreshDoc по ключевому UX:

- Каталог шаблонов
- Опросный лист (анкета) → выбор условий/вариантов
- Заполнение реквизитов сторон и других данных
- Автозаполнение из справочника (сущности в БД)
- Получение готового документа и сохранение в “личном кабинете”

Отдельно: добавить возможность подключить AI-агента, который работает **не с сырым текстом**, а с сущностями и их атрибутами из БД (чтобы не “галлюцинировать реквизиты”).

## 1) Ключевые сущности и почему они нужны

### Сущности справочника (source of truth)
- **Organization** (организация / контрагент): реквизиты для подстановки в документы.
- (Позже) **Person**: представители / подписанты.

### Сущности конструктора
- **Template**: карточка шаблона (название, категория, описание).
- **TemplateVersion**: версия шаблона (тело, правила/логика, схема полей).
- **TemplateField**: поле анкеты (ключ, тип, обязательность, порядок, варианты).

### Сущности результата
- **GeneratedDocument**: связь “сгенерированный документ” ↔ “какой шаблон/версия” + “какие данные подставлялись”.
- Файлы/артефакты: хранятся на диске и ссылаются из БД.

## 2) Пользовательский путь (как в FreshDoc)

1. Пользователь открывает **Каталог шаблонов** (поиск/рубрикатор).
2. Выбирает шаблон → `Создать документ`.
3. Заполняет **Опросный лист**:
   - отвечает на вопросы (варианты)
   - заполняет реквизиты (часть автоподставляется из справочника)
4. Нажимает `Сгенерировать`.
5. Получает **готовый документ**:
   - можно скачать
   - можно сохранить в библиотеке
   - можно создать новую версию

## 3) Опросный лист (анкета)

Для каждого `TemplateVersion` хранится список `TemplateField`.

Минимальные типы полей:
- `text`, `number`, `date`, `boolean`, `choice`
- `organization_ref` — ссылка на организацию из БД

Правило автозаполнения:
- если поле — `organization_ref`, пользователь выбирает организацию из справочника
- backend может автоматически развернуть реквизиты организации в дополнительные поля (например: `party1_name`, `party1_inn`, `party1_address`)

## 4) Генерация документа (без AI как базовый слой)

Базовая генерация должна быть детерминированной:

- `TemplateVersion.body` содержит шаблон с плейсхолдерами (например Jinja2: `{{ party1_name }}`)
- backend валидирует, что обязательные поля анкеты заполнены
- backend рендерит результат и сохраняет как артефакт

AI не должен быть обязательным для генерации.

## 5) AI агент по сущностям (подключаемый слой)

Задачи AI в системе:

- Помогать **найти** нужную сущность (организацию) по неполному запросу.
- Помогать **заполнить анкету**: предложить значения полей на основе выбранных сущностей.
- Делать “умные” операции (перефразировать предмет, предложить формулировки), но **не подменять реквизиты**.

Ключевое правило:
- Реквизиты и атрибуты сторон берутся из БД.
- AI может предложить, но итоговые значения фиксируются как структурированные поля в БД.

## 6) Необходимые API-контракты (минимум)

Справочник:
- CRUD по организациям
- Поиск по названию/ИНН

Шаблоны:
- CRUD по шаблонам
- Версии шаблонов
- Список полей анкеты

Генерация:
- `POST /generate` (template_version_id + data)
- Результат — новый документ + ссылка на артефакт

AI (минимум для старта):
- эндпоинт, который помогает сформировать `data` для анкеты на базе выбранных сущностей (позже)

## 7) Ограничения / anti-goals (чтобы не расползтись)

- Не копируем тексты/шаблоны FreshDoc (авторские права). Делаем собственные шаблоны.
- На первом этапе можно выдавать `.txt`/`markdown`. Экспорт в `.docx/.pdf` — отдельной задачей.
- Сложная вариативность “блоками” как у FreshDoc — позже; начнём со схемы полей + простого рендеринга.
